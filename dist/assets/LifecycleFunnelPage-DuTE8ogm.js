import{r as n,j as s,B as a,T as t,F as U,I as V,S as H,b as P,P as p,C as A,V as Y,m as v}from"./index-D1WZwRG5.js";import{M as G}from"./MenuItem-C9hTkJKZ.js";import{S as y}from"./Stack-BDxuP9_X.js";import{B}from"./Button-BhZ-lD3l.js";import{F as J}from"./FileDownload-xGpG_pRF.js";import{A as m}from"./Alert-C2uN4Clt.js";import{C as K,a as X}from"./CardContent-C09eNwcx.js";import{C as Z}from"./Chip-BcfuiGLT.js";import{S as ee}from"./Snackbar-8yKmYgF-.js";import{D as se}from"./Drawer-7E5gQ_7V.js";const b={subscriber:"Subscriber",lead:"Lead",mql:"MQL",sql:"SQL",opportunity:"Opportunity",customer:"Customer"},I={subscriber:"#6B7280",lead:"#3B82F6",mql:"#F59E0B",sql:"#DC2626",opportunity:"#7C3AED",customer:"#16A34A"},te={current_quarter:"Q1 2026",last_quarter:"Q4 2025",ytd:"YTD 2026",custom_range:"Custom Range"},pe=()=>{const[q,C]=n.useState(!0),[S,h]=n.useState(null),[d,E]=n.useState("current_quarter"),[l,$]=n.useState(null),[u,w]=n.useState({from:"2026-01-01",to:"2026-03-31"}),[c,D]=n.useState(null),[W,L]=n.useState(!1),[k,T]=n.useState([]),[F,N]=n.useState([]),[g,j]=n.useState({open:!1,message:"",severity:"info"}),O=async()=>{try{C(!0),h(null);const e=await v.leads.getLifecycleFunnel({period:d,customRange:d==="custom_range"?u:void 0});$(e.data||null)}catch(e){h(e instanceof Error?e.message:"Erro ao carregar funil")}finally{C(!1)}};n.useEffect(()=>{O()},[d,u.from,u.to]);const _=n.useMemo(()=>{var e;return((e=l==null?void 0:l.stages[0])==null?void 0:e.count)||1},[l]),M=()=>{if(!l)return;const e=["Stage","Count","Percentual","AvgDays","ConversionRate","ConversionAvgDays"],o=l.stages.map(i=>[b[i.stage],String(i.count),i.percentage.toFixed(1),String(i.avgDaysInStage),i.conversionToNext?`${(i.conversionToNext.rate*100).toFixed(1)}%`:"",i.conversionToNext?String(i.conversionToNext.avgDays):""]),x=[e,...o].map(i=>i.map(Q=>`"${Q}"`).join(",")).join(`
`),r=new Blob([x],{type:"text/csv;charset=utf-8;"}),R=URL.createObjectURL(r),f=document.createElement("a");f.href=R,f.download=`lifecycle-funnel-${d}.csv`,f.click(),URL.revokeObjectURL(R),j({open:!0,message:"CSV exportado com sucesso",severity:"success"})},z=async e=>{var o,x;D(e),L(!0),T([]),N([]);try{if(e.stage==="subscriber"||e.stage==="lead"||e.stage==="mql"){const r=await v.leads.list({lifecycle:e.stage},1,200);T(((o=r.data)==null?void 0:o.data)||[])}else{const r=await v.contacts.list({lifecycleStage:[e.stage]},1,200);N(((x=r.data)==null?void 0:x.data)||[])}}finally{L(!1)}};return s.jsxs(a,{sx:{p:3},children:[s.jsxs(a,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[s.jsxs(a,{children:[s.jsx(t,{variant:"h4",sx:{fontWeight:700},children:"ðŸ“Š Lifecycle Funnel"}),s.jsx(t,{variant:"body2",color:"text.secondary",children:"ConversÃ£o por estÃ¡gio de lifecycle para identificar gargalos de marketing."})]}),s.jsxs(a,{sx:{display:"flex",gap:1.5},children:[s.jsxs(U,{size:"small",sx:{minWidth:170},children:[s.jsx(V,{children:"PerÃ­odo"}),s.jsx(H,{value:d,label:"PerÃ­odo",onChange:e=>E(e.target.value),children:Object.entries(te).map(([e,o])=>s.jsx(G,{value:e,children:o},e))})]}),d==="custom_range"&&s.jsxs(y,{direction:"row",spacing:1,children:[s.jsx(P,{size:"small",type:"date",label:"De",value:u.from,onChange:e=>w(o=>({...o,from:e.target.value})),InputLabelProps:{shrink:!0}}),s.jsx(P,{size:"small",type:"date",label:"AtÃ©",value:u.to,onChange:e=>w(o=>({...o,to:e.target.value})),InputLabelProps:{shrink:!0}})]}),s.jsx(B,{variant:"outlined",startIcon:s.jsx(J,{}),onClick:M,children:"Exportar CSV"})]})]}),S&&s.jsx(m,{severity:"error",sx:{mb:2},onClose:()=>h(null),children:S}),q?s.jsx(p,{sx:{p:6,textAlign:"center"},children:s.jsx(A,{})}):l?s.jsxs(s.Fragment,{children:[s.jsx(p,{sx:{p:2.5,mb:2.5},children:l.stages.map(e=>{const o=Math.max(16,e.count/_*100),x=e.conversionToNext?(e.conversionToNext.rate*100).toFixed(1):null;return s.jsxs(a,{sx:{mb:1.5},children:[s.jsx(Y,{arrow:!0,title:s.jsxs(a,{sx:{p:.5},children:[s.jsx(t,{variant:"caption",sx:{fontWeight:700,display:"block"},children:"Breakdown"}),(e.topSources||[]).slice(0,2).map(r=>s.jsxs(t,{variant:"caption",sx:{display:"block"},children:["Source: ",r.source," (",r.count,")"]},`${e.stage}-source-${r.source}`)),(e.topOwners||[]).slice(0,2).map(r=>s.jsxs(t,{variant:"caption",sx:{display:"block"},children:["Owner: ",r.ownerName," (",r.count,")"]},`${e.stage}-owner-${r.ownerName}`)),s.jsx(t,{variant:"caption",sx:{mt:.5,display:"block",opacity:.9},children:"Clique para drill-down"})]}),children:s.jsx(B,{onClick:()=>z(e),sx:{width:`${o}%`,borderRadius:2,px:2,py:1.5,color:"#fff",backgroundColor:I[e.stage],justifyContent:"flex-start",textTransform:"none","&:hover":{backgroundColor:I[e.stage],filter:"brightness(1.08)"}},children:s.jsxs(a,{children:[s.jsx(t,{variant:"body1",sx:{fontWeight:700},children:b[e.stage]}),s.jsxs(t,{variant:"body2",children:[e.count.toLocaleString("pt-BR")," contatos (",e.percentage.toFixed(1),"%)"]}),s.jsxs(t,{variant:"caption",children:["Avg Time: ",e.avgDaysInStage," dias"]})]})})}),e.conversionToNext&&s.jsxs(t,{variant:"caption",sx:{mt:.4,ml:1,display:"block",color:e.conversionToNext.rate<.3?"error.main":"text.secondary",fontWeight:e.conversionToNext.rate<.3?700:500},children:["â†“ ",x,"% conversion (",e.conversionToNext.avgDays," dias mÃ©dios)"]})]},e.stage)})}),s.jsx(K,{children:s.jsxs(X,{children:[s.jsx(t,{variant:"h6",sx:{mb:1},children:"ðŸ’¡ Insights"}),s.jsx(a,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:l.insights.map(e=>s.jsx(Z,{label:e.message,color:e.type==="bottleneck"?"error":e.type==="warning"?"warning":"success",variant:"outlined"},e.message))})]})})]}):s.jsx(p,{sx:{p:4},children:"Sem dados de funil."}),s.jsx(ee,{open:g.open,autoHideDuration:2400,onClose:()=>j(e=>({...e,open:!1})),children:s.jsx(m,{severity:g.severity,onClose:()=>j(e=>({...e,open:!1})),sx:{width:"100%"},children:g.message})}),s.jsxs(se,{anchor:"right",open:!!c,onClose:()=>D(null),PaperProps:{sx:{width:{xs:"100%",md:500},p:2}},children:[s.jsxs(t,{variant:"h6",sx:{mb:1},children:["Drill-down â€¢ ",c?b[c.stage]:""]}),s.jsx(t,{variant:"body2",color:"text.secondary",sx:{mb:2},children:c?`${c.count.toLocaleString("pt-BR")} registros no estÃ¡gio`:""}),W?s.jsx(a,{sx:{py:4,textAlign:"center"},children:s.jsx(A,{size:24})}):c&&(c.stage==="subscriber"||c.stage==="lead"||c.stage==="mql")?s.jsx(a,{children:k.length===0?s.jsx(m,{severity:"info",children:"Nenhum lead encontrado para este estÃ¡gio."}):s.jsx(y,{spacing:1,children:k.slice(0,20).map(e=>s.jsxs(p,{variant:"outlined",sx:{p:1.2},children:[s.jsx(t,{variant:"body2",sx:{fontWeight:600},children:e.fullName}),s.jsxs(t,{variant:"caption",color:"text.secondary",children:[e.email," â€¢ Score ",e.leadScore]})]},e.id))})}):s.jsx(a,{children:F.length===0?s.jsx(m,{severity:"info",children:"Nenhum contato encontrado para este estÃ¡gio."}):s.jsx(y,{spacing:1,children:F.slice(0,20).map(e=>s.jsxs(p,{variant:"outlined",sx:{p:1.2},children:[s.jsx(t,{variant:"body2",sx:{fontWeight:600},children:e.fullName}),s.jsxs(t,{variant:"caption",color:"text.secondary",children:[e.email," â€¢ Score ",e.leadScore]})]},e.id))})})]})]})};export{pe as default};
