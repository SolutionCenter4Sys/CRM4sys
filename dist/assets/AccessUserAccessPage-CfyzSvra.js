import{r,j as e,B as N,T as o,P as u,b as v,C as de,m as n}from"./index-D1WZwRG5.js";import{S as l}from"./Stack-BDxuP9_X.js";import{M as S}from"./MenuItem-C9hTkJKZ.js";import{B as m}from"./Button-BhZ-lD3l.js";import{C as c}from"./Chip-BcfuiGLT.js";import{T as ue,a as me,b as pe,c as R,d,e as xe}from"./TableRow-CbZqZsXt.js";import{D as he,a as ge,b as ve,c as fe}from"./DialogTitle-CaeVllRe.js";import{S as je}from"./Snackbar-8yKmYgF-.js";import{A as ye}from"./Alert-C2uN4Clt.js";const Re=()=>{const[L,f]=r.useState(!0),[w,J]=r.useState([]),[K,M]=r.useState([]),[H,_]=r.useState([]),[a,$]=r.useState(""),[P,V]=r.useState([]),[T,O]=r.useState([]),[p,q]=r.useState(null),[Q,X]=r.useState([]),[F,Y]=r.useState([]),[Z,j]=r.useState(!1),[E,ee]=r.useState("deals.view"),[G,I]=r.useState(""),[U,W]=r.useState(""),[y,B]=r.useState(""),[g,se]=r.useState(null),[A,t]=r.useState({open:!1,message:"",severity:"success"}),k=r.useMemo(()=>w.find(s=>s.id===a)||null,[w,a]),ae=async()=>{var s;f(!0);try{const[i,b,C]=await Promise.all([n.users.list(),n.access.listGroups({search:null,isActive:!0,page:1,pageSize:200}),n.access.listPermissionCatalog()]),x=i.data||[];J(x),M(((s=b.data)==null?void 0:s.data)||[]),_(C.data||[]),!a&&x[0]&&$(x[0].id)}catch(i){t({open:!0,message:i.message||"Falha ao carregar dados",severity:"error"})}finally{f(!1)}},h=async s=>{var i,b,C;if(s){f(!0);try{const[x,ce,D]=await Promise.all([n.access.listUserGroups(s),n.access.listDirectPermissions(s),n.access.getEffectiveAccess(s)]);V(x.data||[]),O(ce.data||[]),q(((i=D.data)==null?void 0:i.summary)||null),X(((b=D.data)==null?void 0:b.permissions)||[]),Y(((C=D.data)==null?void 0:C.conflicts)||[])}catch(x){t({open:!0,message:x.message||"Falha ao carregar acesso do usuário",severity:"error"})}finally{f(!1)}}};r.useEffect(()=>{ae()},[]),r.useEffect(()=>{a&&h(a)},[a]);const re=async()=>{if(!(!a||!y))try{await n.access.addUserToGroups(a,[y]),t({open:!0,message:"Usuário vinculado ao grupo.",severity:"success"}),B(""),await h(a)}catch(s){t({open:!0,message:s.message||"Falha ao vincular grupo",severity:"error"})}},ie=async s=>{if(a)try{await n.access.removeUserFromGroup(a,s),t({open:!0,message:"Usuário removido do grupo.",severity:"success"}),await h(a)}catch(i){t({open:!0,message:i.message||"Falha ao remover grupo",severity:"error"})}},te=async()=>{if(!a||!G.trim()){t({open:!0,message:"Preencha justificativa para conceder acesso.",severity:"error"});return}try{await n.access.grantDirectPermission({userId:a,permissionKey:E,justification:G.trim(),expiresAt:U||null}),j(!1),I(""),W(""),t({open:!0,message:"Permissão direta concedida.",severity:"success"}),await h(a)}catch(s){t({open:!0,message:s.message||"Falha ao conceder permissão",severity:"error"})}},oe=async s=>{if(a)try{await n.access.revokeDirectPermission(s),t({open:!0,message:"Permissão revogada.",severity:"success"}),await h(a)}catch(i){t({open:!0,message:i.message||"Falha ao revogar permissão",severity:"error"})}},ne=async s=>{if(a)try{await n.access.resolveConflict(s,"revoke_direct"),t({open:!0,message:"Conflito resolvido.",severity:"success"}),await h(a)}catch(i){t({open:!0,message:i.message||"Falha ao resolver conflito",severity:"error"})}},z=async s=>{if(a)try{const i=await n.access.simulateChange(a,s);se(i.data||null)}catch(i){t({open:!0,message:i.message||"Falha na simulação",severity:"error"})}},le=K.filter(s=>!P.some(i=>i.groupId===s.id));return e.jsxs(N,{sx:{p:3},children:[e.jsx(o,{variant:"h4",fontWeight:700,sx:{mb:2},children:"Gestão de Acesso por Usuário"}),e.jsx(u,{sx:{p:2,mb:2},children:e.jsxs(l,{direction:{xs:"column",md:"row"},spacing:2,children:[e.jsx(v,{select:!0,size:"small",label:"Usuário",value:a,onChange:s=>$(s.target.value),sx:{minWidth:320},children:w.map(s=>e.jsxs(S,{value:s.id,children:[s.fullName," (",s.email,")"]},s.id))}),e.jsx(m,{variant:"outlined",onClick:()=>j(!0),disabled:!k,children:"Conceder permissão direta"}),e.jsx(m,{variant:"outlined",onClick:()=>z("grant_permission"),disabled:!k,children:"Simular concessão"}),e.jsx(m,{variant:"outlined",onClick:()=>z("revoke_permission"),disabled:!k,children:"Simular revogação"})]})}),L?e.jsx(N,{sx:{display:"flex",justifyContent:"center",py:6},children:e.jsx(de,{})}):e.jsxs(l,{spacing:2,children:[e.jsxs(u,{sx:{p:2},children:[e.jsx(o,{variant:"h6",children:"Resumo de acesso efetivo"}),p?e.jsxs(l,{direction:"row",spacing:1,flexWrap:"wrap",useFlexGap:!0,sx:{mt:1},children:[e.jsx(c,{label:`Grupos: ${p.groupsCount}`}),e.jsx(c,{label:`Diretas: ${p.directPermissionsCount}`}),e.jsx(c,{label:`Herdadas: ${p.inheritedPermissionsCount}`}),e.jsx(c,{label:`Total: ${p.totalEffectivePermissions}`,color:"primary"}),e.jsx(c,{label:`Conflitos: ${p.conflictsCount}`,color:p.conflictsCount>0?"warning":"default"})]}):e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Selecione um usuário para calcular o acesso efetivo."})]}),e.jsxs(u,{sx:{p:2},children:[e.jsx(o,{variant:"h6",children:"Grupos vinculados"}),e.jsxs(l,{direction:{xs:"column",md:"row"},spacing:1,sx:{my:1},children:[e.jsxs(v,{select:!0,size:"small",label:"Adicionar em grupo",value:y,onChange:s=>B(s.target.value),sx:{minWidth:260},children:[e.jsx(S,{value:"",children:"Selecione..."}),le.map(s=>e.jsx(S,{value:s.id,children:s.name},s.id))]}),e.jsx(m,{variant:"contained",onClick:re,disabled:!y,children:"Adicionar"})]}),e.jsx(l,{direction:"row",spacing:1,flexWrap:"wrap",useFlexGap:!0,children:P.length===0?e.jsx(o,{variant:"body2",color:"text.secondary",children:"Sem grupos vinculados."}):P.map(s=>e.jsx(c,{label:s.groupName,onDelete:()=>ie(s.groupId)},`${s.userId}-${s.groupId}`))})]}),e.jsxs(u,{sx:{p:2},children:[e.jsx(o,{variant:"h6",sx:{mb:1},children:"Permissões diretas"}),e.jsx(ue,{children:e.jsxs(me,{size:"small",children:[e.jsx(pe,{children:e.jsxs(R,{children:[e.jsx(d,{children:"Permissão"}),e.jsx(d,{children:"Justificativa"}),e.jsx(d,{children:"Válida até"}),e.jsx(d,{align:"right",children:"Ações"})]})}),e.jsx(xe,{children:T.length===0?e.jsx(R,{children:e.jsx(d,{colSpan:4,align:"center",children:e.jsx(o,{variant:"body2",color:"text.secondary",sx:{py:2},children:"Nenhuma permissão direta ativa."})})}):T.map(s=>e.jsxs(R,{children:[e.jsx(d,{children:s.permissionLabel}),e.jsx(d,{children:s.justification}),e.jsx(d,{children:s.expiresAt?new Date(s.expiresAt).toLocaleDateString("pt-BR"):"Sem validade"}),e.jsx(d,{align:"right",children:e.jsx(m,{color:"error",size:"small",onClick:()=>oe(s.id),children:"Revogar"})})]},s.id))})]})})]}),e.jsxs(u,{sx:{p:2},children:[e.jsx(o,{variant:"h6",sx:{mb:1},children:"Permissões efetivas (diretas e herdadas)"}),e.jsx(l,{direction:"row",spacing:1,flexWrap:"wrap",useFlexGap:!0,children:Q.map(s=>e.jsx(c,{label:`${s.permissionLabel} (${s.origin==="direct"?"Direta":`Grupo: ${s.sourceName}`})`,color:s.origin==="direct"?"primary":"default",variant:s.origin==="direct"?"filled":"outlined"},`${s.permissionKey}-${s.origin}-${s.sourceName}`))})]}),e.jsxs(u,{sx:{p:2},children:[e.jsx(o,{variant:"h6",sx:{mb:1},children:"Conflitos de permissão"}),F.length===0?e.jsx(o,{variant:"body2",color:"text.secondary",children:"Nenhum conflito identificado."}):e.jsx(l,{spacing:1,children:F.map(s=>e.jsx(u,{variant:"outlined",sx:{p:2},children:e.jsxs(l,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(o,{variant:"subtitle2",children:s.reason}),e.jsx(m,{size:"small",variant:"outlined",onClick:()=>ne(s.conflictId),children:"Resolver"})]})},s.conflictId))})]}),g&&e.jsxs(u,{sx:{p:2},children:[e.jsx(o,{variant:"h6",children:"Resultado da simulação"}),e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mb:1},children:"Impacto previsto antes de aplicar mudanças."}),e.jsxs(l,{direction:"row",spacing:1,flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(c,{label:`Adicionadas: ${g.diff.added.length}`,color:"success"}),e.jsx(c,{label:`Removidas: ${g.diff.removed.length}`,color:"warning"}),e.jsx(c,{label:`Críticas: ${g.diff.criticalChanges.length}`,color:g.diff.criticalChanges.length>0?"error":"default"})]})]})]}),e.jsxs(he,{open:Z,onClose:()=>j(!1),fullWidth:!0,maxWidth:"sm",children:[e.jsx(ge,{children:"Conceder permissão direta"}),e.jsx(ve,{children:e.jsxs(l,{spacing:2,sx:{mt:1},children:[e.jsx(v,{select:!0,label:"Permissão",value:E,onChange:s=>ee(s.target.value),children:H.map(s=>e.jsx(S,{value:s.key,children:s.label},s.key))}),e.jsx(v,{label:"Justificativa",multiline:!0,minRows:3,value:G,onChange:s=>I(s.target.value)}),e.jsx(v,{label:"Válida até (opcional)",type:"date",value:U,onChange:s=>W(s.target.value),InputLabelProps:{shrink:!0}})]})}),e.jsxs(fe,{children:[e.jsx(m,{onClick:()=>j(!1),children:"Cancelar"}),e.jsx(m,{variant:"contained",onClick:te,children:"Conceder"})]})]}),e.jsx(je,{open:A.open,autoHideDuration:3500,onClose:()=>t(s=>({...s,open:!1})),children:e.jsx(ye,{severity:A.severity,variant:"filled",onClose:()=>t(s=>({...s,open:!1})),children:A.message})})]})};export{Re as default};
