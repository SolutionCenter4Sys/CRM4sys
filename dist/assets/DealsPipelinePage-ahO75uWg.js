import{u as he,r as n,j as t,B as l,C as fe,T as u,P as Q,b as R,R as je,U as be,F as Y,I as Z,S as _,m}from"./index-D1WZwRG5.js";import{D as ee}from"./DealFormModal-Q0-oxKjZ.js";import{B as z}from"./Button-BhZ-lD3l.js";import{A as ve}from"./Add-CgRR7ozh.js";import{M as p}from"./MenuItem-C9hTkJKZ.js";import{C as c}from"./Chip-BcfuiGLT.js";import{A as te}from"./Alert-C2uN4Clt.js";import{C as we,a as ye}from"./CardContent-C09eNwcx.js";import"./DialogTitle-CaeVllRe.js";import"./Stack-BDxuP9_X.js";const Le=()=>{const se=he(),[ae,A]=n.useState(!0),[$,h]=n.useState(null),[d,ne]=n.useState(null),[x,oe]=n.useState([]),[g,E]=n.useState([]),[M,re]=n.useState(""),[f,L]=n.useState(null),[ie,P]=n.useState(!1),[le,B]=n.useState(!1),[j,F]=n.useState(null),[b,N]=n.useState(""),[v,O]=n.useState("open"),[w,T]=n.useState(""),[y,W]=n.useState(""),[C,V]=n.useState(""),S=async()=>{try{A(!0),h(null);const a=((await m.pipelines.list()).data||[])[0];if(!a)throw new Error("Nenhum pipeline cadastrado");ne(a);const[o,s]=await Promise.all([m.pipelines.listStages(a.id),m.deals.list()]);oe(o.data||[]),E((s.data||[]).filter(i=>i.pipelineId===a.id))}catch(e){h(e instanceof Error?e.message:"Erro ao carregar pipeline")}finally{A(!1)}};n.useEffect(()=>{S()},[]);const r=n.useMemo(()=>{const e=M.trim().toLowerCase();return g.filter(a=>{var H,X,J,K;const o=!e||a.title.toLowerCase().includes(e)||((X=(H=a.account)==null?void 0:H.name)==null?void 0:X.toLowerCase().includes(e))||((K=(J=a.owner)==null?void 0:J.fullName)==null?void 0:K.toLowerCase().includes(e)),s=!b||a.ownerId===b,i=v==="all"||a.status===v,D=!w||a.amount>=Number(w),I=!y||a.amount<=Number(y),ge=!C||(a.rottingDays||0)>=Number(C);return o&&s&&i&&D&&I&&ge})},[g,M,b,v,w,y,C]),ce=n.useMemo(()=>{const e=new Map;return g.forEach(a=>{var o;a.ownerId&&((o=a.owner)!=null&&o.fullName)&&e.set(a.ownerId,a.owner.fullName)}),Array.from(e.entries()).map(([a,o])=>({id:a,fullName:o}))},[g]),ue=n.useMemo(()=>r.filter(e=>e.status==="open").reduce((e,a)=>e+a.amount,0),[r]),k=n.useMemo(()=>r.filter(e=>e.status==="open").reduce((e,a)=>e+a.weightedAmount,0),[r]),de=n.useMemo(()=>r.filter(e=>e.status==="won").reduce((e,a)=>e+a.amount,0),[r]),G=n.useMemo(()=>{const e=r.filter(s=>s.status==="won").length,a=r.filter(s=>s.status==="lost").length,o=e+a;return o===0?0:e/o*100},[r]),U=n.useMemo(()=>{const e=r.filter(o=>o.status==="open");return e.length?e.reduce((o,s)=>o+(s.rottingDays||0),0)/e.length:0},[r]),q=n.useMemo(()=>r.filter(e=>e.status==="open"&&(e.rottingDays||0)>=10).length,[r]),me=async e=>{if(!f)return;const a=g.find(s=>s.id===f);if(!a||a.stageId===e)return;const o=x.find(s=>s.id===e);if(o){E(s=>s.map(i=>i.id===f?{...i,stageId:o.id,stage:o,probability:o.probability,weightedAmount:i.amount*o.probability/100}:i));try{await m.deals.moveToStage(f,e)}catch(s){h(s instanceof Error?s.message:"Erro ao mover deal"),await S()}}},pe=async e=>{await m.deals.create(e),await S()},xe=async e=>{j&&(await m.deals.update(j.id,e),await S())};return ae?t.jsx(l,{sx:{display:"flex",justifyContent:"center",py:8},children:t.jsx(fe,{})}):t.jsxs(l,{sx:{p:3},children:[t.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:2,mb:3},children:[t.jsxs(l,{children:[t.jsx(u,{variant:"h4",sx:{fontWeight:700},children:"ðŸ’¼ Pipeline de Deals"}),t.jsxs(u,{variant:"body2",color:"text.secondary",children:[d==null?void 0:d.name," â€¢ Arraste e solte deals entre estÃ¡gios."]})]}),t.jsx(z,{variant:"contained",startIcon:t.jsx(ve,{}),onClick:()=>P(!0),children:"Novo Deal"})]}),t.jsxs(Q,{sx:{p:2,mb:2},children:[t.jsxs(l,{sx:{display:"flex",gap:2,flexWrap:"wrap",alignItems:"center",mb:2},children:[t.jsx(R,{size:"small",placeholder:"Buscar deals...",value:M,onChange:e=>re(e.target.value),sx:{minWidth:300},InputProps:{startAdornment:t.jsx(je,{position:"start",children:t.jsx(be,{fontSize:"small"})})}}),t.jsxs(Y,{size:"small",sx:{minWidth:180},children:[t.jsx(Z,{children:"Owner"}),t.jsxs(_,{label:"Owner",value:b,onChange:e=>N(e.target.value),children:[t.jsx(p,{value:"",children:"Todos"}),ce.map(e=>t.jsx(p,{value:e.id,children:e.fullName},e.id))]})]}),t.jsxs(Y,{size:"small",sx:{minWidth:140},children:[t.jsx(Z,{children:"Status"}),t.jsxs(_,{label:"Status",value:v,onChange:e=>O(e.target.value),children:[t.jsx(p,{value:"open",children:"Abertos"}),t.jsx(p,{value:"won",children:"Ganhos"}),t.jsx(p,{value:"lost",children:"Perdidos"}),t.jsx(p,{value:"all",children:"Todos"})]})]}),t.jsx(R,{size:"small",label:"Valor min",type:"number",value:w,onChange:e=>T(e.target.value),sx:{width:120}}),t.jsx(R,{size:"small",label:"Valor max",type:"number",value:y,onChange:e=>W(e.target.value),sx:{width:120}}),t.jsx(R,{size:"small",label:"Rotting >= dias",type:"number",value:C,onChange:e=>V(e.target.value),sx:{width:140}}),t.jsx(z,{variant:"text",onClick:()=>{N(""),O("open"),T(""),W(""),V("")},children:"Limpar filtros"})]}),t.jsxs(l,{sx:{display:"grid",gap:1,gridTemplateColumns:"repeat(5, minmax(160px, 1fr))"},children:[t.jsx(c,{label:`Deals: ${r.length}`,color:"default",variant:"outlined",size:"small"}),t.jsx(c,{label:`Valor aberto: R$ ${ue.toLocaleString("pt-BR")}`,color:"primary",variant:"outlined",size:"small"}),t.jsx(c,{label:`Valor ponderado: R$ ${k.toLocaleString("pt-BR")}`,color:"success",variant:"outlined",size:"small"}),t.jsx(c,{label:`Forecast: R$ ${k.toLocaleString("pt-BR")}`,color:"info",variant:"outlined",size:"small"}),t.jsx(c,{label:`Ganhos: R$ ${de.toLocaleString("pt-BR")}`,color:"success",variant:"outlined",size:"small"}),t.jsx(c,{label:`Win Rate: ${G.toFixed(1)}%`,color:G>=35?"success":"warning",variant:"outlined",size:"small"}),t.jsx(c,{label:`Aging mÃ©dio: ${U.toFixed(1)}d`,color:U>=8?"warning":"default",variant:"outlined",size:"small"})]})]}),$&&t.jsx(te,{severity:"error",sx:{mb:2},onClose:()=>h(null),children:$}),q>0&&t.jsxs(te,{severity:"warning",sx:{mb:2},children:[q," deal(s) com rotting crÃ­tico (",">="," 10 dias)."]}),t.jsx(l,{sx:{display:"grid",gridTemplateColumns:`repeat(${Math.max(x.length,1)}, minmax(250px, 1fr))`,gap:2,alignItems:"start",overflowX:"auto"},children:x.map(e=>{const a=r.filter(s=>s.stageId===e.id),o=a.reduce((s,i)=>s+i.amount,0);return t.jsxs(Q,{onDragOver:s=>s.preventDefault(),onDrop:()=>me(e.id),sx:{p:1.5,minHeight:480,backgroundColor:"grey.50",borderTop:`4px solid ${e.color}`},children:[t.jsxs(l,{sx:{mb:1.5},children:[t.jsx(u,{variant:"subtitle2",sx:{fontWeight:700},children:e.name}),t.jsxs(u,{variant:"caption",color:"text.secondary",children:[a.length," deal(s) â€¢ R$ ",o.toLocaleString("pt-BR")," â€¢"," ",e.probability,"%"]})]}),t.jsx(l,{sx:{display:"flex",flexDirection:"column",gap:1},children:a.map(s=>{var i,D;return t.jsx(we,{draggable:!0,onDragStart:()=>L(s.id),onDragEnd:()=>L(null),onClick:()=>se(`/deals/${s.id}`),sx:{cursor:"grab",border:1,borderColor:(s.rottingDays||0)>=10?"error.main":(s.rottingDays||0)>=7?"warning.main":"divider"},children:t.jsxs(ye,{sx:{pb:"16px !important"},children:[t.jsx(u,{variant:"body2",sx:{fontWeight:700},children:s.title}),t.jsx(u,{variant:"caption",color:"text.secondary",children:((i=s.account)==null?void 0:i.name)||"Conta nÃ£o definida"}),t.jsxs(u,{variant:"body2",sx:{mt:1},children:["R$ ",s.amount.toLocaleString("pt-BR")]}),t.jsxs(u,{variant:"caption",color:"text.secondary",children:["Owner: ",((D=s.owner)==null?void 0:D.fullName)||"â€”"]}),t.jsxs(l,{sx:{mt:1,display:"flex",justifyContent:"space-between",alignItems:"center",gap:1},children:[t.jsx(c,{size:"small",label:s.status.toUpperCase(),color:s.status==="won"?"success":s.status==="lost"?"error":"default",variant:"outlined"}),t.jsx(c,{size:"small",label:`Rotting: ${s.rottingDays||0}d`,color:(s.rottingDays||0)>=10?"error":(s.rottingDays||0)>=7?"warning":"default",variant:"outlined"}),t.jsx(z,{size:"small",onClick:I=>{I.stopPropagation(),F(s),B(!0)},children:"Editar"})]})]})},s.id)})})]},e.id)})}),d&&t.jsx(ee,{open:ie,onClose:()=>P(!1),onSubmit:pe,pipelineId:d.id,stages:x}),d&&j&&t.jsx(ee,{open:le,mode:"edit",initialData:j,onClose:()=>{B(!1),F(null)},onSubmit:xe,pipelineId:d.id,stages:x})]})};export{Le as DealsPipelinePage,Le as default};
