import{x as q,j as e,Z as X,a as Z,u as _,r as o,B as C,C as H,T as r,P,D as J,b as m,m as h}from"./index-D1WZwRG5.js";import{B as x}from"./Button-BhZ-lD3l.js";import{A as K}from"./ArrowBack-ChqsaD63.js";import{S as n}from"./Stack-BDxuP9_X.js";import{C as R}from"./Chip-BcfuiGLT.js";import{P as Y}from"./Payment-K_mflVr5.js";import{G as I}from"./Grid-DMeR_RpR.js";import{T as ee,a as T}from"./Tabs-CY_i16F1.js";import{T as te,a as ae,b as re,c as E,d as l,e as se}from"./TableRow-CbZqZsXt.js";import{D as ne,a as ie,b as oe,c as le}from"./DialogTitle-CaeVllRe.js";import{F}from"./FormControlLabel-CTGze361.js";import{C as N}from"./Checkbox-CkPVwaBf.js";import{M as j}from"./MenuItem-C9hTkJKZ.js";import{S as ce}from"./Snackbar-8yKmYgF-.js";import{A as de}from"./Alert-C2uN4Clt.js";import"./KeyboardArrowRight-DRYK2Ozh.js";import"./SwitchBase-TQvPBqmb.js";const ue=q(e.jsx("path",{d:"M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9m-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8z"}),"History"),he=q(e.jsx("path",{d:"M7 7h10v3l4-4-4-4v3H5v6h2zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2z"}),"Repeat"),me={draft:"Rascunho",open:"Em aberto",partial:"Parcial",paid:"Paga",overdue:"Vencida",cancelled:"Cancelada"},xe={draft:"default",open:"info",partial:"warning",paid:"success",overdue:"error",cancelled:"default"},Ae=()=>{const{id:p}=X(),[k]=Z(),O=_(),[z,A]=o.useState(!0),[a,W]=o.useState(null),[D,M]=o.useState([]),[c,V]=o.useState(null),[S,L]=o.useState("details"),[$,g]=o.useState(!1),[f,G]=o.useState("full"),[s,d]=o.useState({receivedAt:new Date().toISOString().slice(0,10),method:"pix",confirmPolicy:!1}),[w,B]=o.useState(!1),[y,b]=o.useState({open:!1,message:"",severity:"success"});o.useEffect(()=>{(async()=>{if(p){A(!0);try{const[u,v,Q]=await Promise.all([h.billingInvoices.getById(p),h.payments.listHistory(p),h.billingInvoices.getRecurrenceRule(p)]);W(u.data||null),M(v.data||[]),V(Q.data||null),k.get("action")==="payment"&&g(!0)}catch(u){b({open:!0,message:u.message||"Erro ao carregar fatura",severity:"error"})}finally{A(!1)}}})()},[p,k]);const U=async()=>{if(a){B(!0);try{if(f==="full"){const v={invoiceId:a.id,receivedAt:s.receivedAt||new Date().toISOString().slice(0,10),amountReceived:a.totals.amountOpen,method:s.method||"pix",reference:s.reference||null,notes:s.notes||null,confirmPolicy:s.confirmPolicy||!1};await h.payments.recordManualPayment(v)}else{const v={invoiceId:a.id,receivedAt:s.receivedAt||new Date().toISOString().slice(0,10),amountReceived:Number(s.amountReceived||0),method:s.method||"pix",reference:s.reference||null,notes:s.notes||null};await h.payments.recordPartialPayment(v)}b({open:!0,message:"Pagamento registrado",severity:"success"}),g(!1),d({receivedAt:new Date().toISOString().slice(0,10),method:"pix",confirmPolicy:!1});const[t,u]=await Promise.all([h.billingInvoices.getById(a.id),h.payments.listHistory(a.id)]);W(t.data||null),M(u.data||[])}catch(t){b({open:!0,message:t.message||"Erro ao registrar pagamento",severity:"error"})}finally{B(!1)}}},i=t=>`R$ ${t.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`;return z?e.jsx(C,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh"},children:e.jsx(H,{})}):a?e.jsxs(C,{sx:{p:3},children:[e.jsx(x,{startIcon:e.jsx(K,{}),onClick:()=>O("/billing/invoices"),sx:{mb:2},children:"Voltar"}),e.jsxs(P,{sx:{p:3,mb:2},children:[e.jsxs(n,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:2},children:[e.jsxs(C,{children:[e.jsx(r,{variant:"h5",fontWeight:700,children:a.invoiceNumber}),e.jsx(r,{variant:"body2",color:"text.secondary",children:a.accountName})]}),e.jsxs(n,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(R,{label:me[a.status],color:xe[a.status]}),a.status!=="paid"&&a.status!=="cancelled"&&e.jsx(x,{variant:"contained",startIcon:e.jsx(Y,{}),onClick:()=>g(!0),children:"Registrar Pagamento"})]})]}),e.jsxs(I,{container:!0,spacing:2,children:[e.jsxs(I,{item:!0,xs:6,md:3,children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:"Emissão"}),e.jsx(r,{variant:"body1",children:a.issueDate})]}),e.jsxs(I,{item:!0,xs:6,md:3,children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:"Vencimento"}),e.jsx(r,{variant:"body1",color:a.status==="overdue"?"error.main":"inherit",children:a.dueDate})]}),e.jsxs(I,{item:!0,xs:6,md:3,children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:"Total"}),e.jsx(r,{variant:"body1",fontWeight:600,children:i(a.totals.total)})]}),e.jsxs(I,{item:!0,xs:6,md:3,children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:"Saldo em aberto"}),e.jsx(r,{variant:"body1",fontWeight:700,color:a.totals.amountOpen>0?"error.main":"success.main",children:i(a.totals.amountOpen)})]})]})]}),e.jsxs(ee,{value:S,onChange:(t,u)=>L(u),sx:{mb:2,borderBottom:1,borderColor:"divider"},children:[e.jsx(T,{label:"Detalhes",value:"details"}),e.jsx(T,{label:`Histórico (${D.length})`,value:"history",icon:e.jsx(ue,{}),iconPosition:"start"}),e.jsx(T,{label:"Recorrência",value:"recurrence",icon:e.jsx(he,{}),iconPosition:"start"})]}),S==="details"&&e.jsxs(P,{sx:{p:2},children:[e.jsx(r,{variant:"h6",sx:{mb:2},children:"Itens da fatura"}),e.jsx(te,{children:e.jsxs(ae,{size:"small",children:[e.jsx(re,{children:e.jsxs(E,{children:[e.jsx(l,{children:"Descrição"}),e.jsx(l,{align:"right",children:"Qtd"}),e.jsx(l,{align:"right",children:"Preço Unit."}),e.jsx(l,{align:"right",children:"Total"})]})}),e.jsx(se,{children:a.items.map(t=>e.jsxs(E,{children:[e.jsx(l,{children:t.description}),e.jsx(l,{align:"right",children:t.quantity}),e.jsx(l,{align:"right",children:i(t.unitPrice)}),e.jsx(l,{align:"right",children:i(t.quantity*t.unitPrice)})]},t.id))})]})}),e.jsx(J,{sx:{my:2}}),e.jsxs(n,{spacing:1,children:[e.jsxs(n,{direction:"row",justifyContent:"space-between",children:[e.jsx(r,{children:"Subtotal"}),e.jsx(r,{children:i(a.totals.subtotal)})]}),e.jsxs(n,{direction:"row",justifyContent:"space-between",children:[e.jsx(r,{children:"Impostos"}),e.jsx(r,{children:i(a.totals.taxTotal)})]}),e.jsxs(n,{direction:"row",justifyContent:"space-between",children:[e.jsx(r,{fontWeight:700,children:"Total"}),e.jsx(r,{fontWeight:700,children:i(a.totals.total)})]}),e.jsxs(n,{direction:"row",justifyContent:"space-between",children:[e.jsx(r,{children:"Pago"}),e.jsx(r,{color:"success.main",children:i(a.totals.amountPaid)})]}),e.jsxs(n,{direction:"row",justifyContent:"space-between",children:[e.jsx(r,{fontWeight:700,color:"error.main",children:"Saldo em aberto"}),e.jsx(r,{fontWeight:700,color:"error.main",children:i(a.totals.amountOpen)})]})]})]}),S==="history"&&e.jsxs(P,{sx:{p:2},children:[e.jsx(r,{variant:"h6",sx:{mb:2},children:"Histórico de eventos"}),D.length===0?e.jsx(r,{variant:"body2",color:"text.secondary",children:"Nenhum evento registrado"}):e.jsx(n,{spacing:1.5,children:D.map(t=>e.jsxs(P,{variant:"outlined",sx:{p:1.5},children:[e.jsxs(n,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(r,{variant:"body2",fontWeight:600,children:t.title}),e.jsx(R,{size:"small",label:t.type,color:t.type==="payment"?"success":"default",variant:"outlined"})]}),e.jsxs(r,{variant:"caption",color:"text.secondary",children:[new Date(t.createdAt).toLocaleString("pt-BR")," • ",t.createdByName]}),t.description&&e.jsx(r,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:t.description}),t.amount&&e.jsx(r,{variant:"body2",fontWeight:600,color:"success.main",sx:{mt:.5},children:i(t.amount)})]},t.eventId))})]}),S==="recurrence"&&e.jsxs(P,{sx:{p:2},children:[e.jsx(r,{variant:"h6",sx:{mb:2},children:"Configuração de recorrência"}),c?e.jsxs(C,{children:[e.jsxs(n,{spacing:2,children:[e.jsxs(n,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(r,{variant:"body2",children:"Status:"}),e.jsx(R,{label:c.enabled?"Ativa":"Inativa",color:c.enabled?"success":"default",size:"small"})]}),e.jsxs(r,{variant:"body2",children:["Frequência: ",c.frequency==="monthly"?"Mensal":c.frequency==="quarterly"?"Trimestral":"Anual"]}),e.jsxs(r,{variant:"body2",children:["Intervalo: a cada ",c.interval," período(s)"]}),e.jsxs(r,{variant:"body2",children:["Dia do mês: ",c.dayOfMonth]})]}),e.jsx(x,{variant:"outlined",sx:{mt:2},onClick:()=>alert("Editar recorrência (MVP)"),children:"Editar recorrência"})]}):e.jsx(r,{variant:"body2",color:"text.secondary",children:"Nenhuma recorrência configurada para esta fatura."})]}),e.jsxs(ne,{open:$,onClose:()=>!w&&g(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ie,{children:"Registrar Pagamento"}),e.jsx(oe,{children:e.jsxs(n,{spacing:2,sx:{mt:1},children:[e.jsx(F,{control:e.jsx(N,{checked:f==="full",onChange:t=>G(t.target.checked?"full":"partial")}),label:"Baixa integral (quitar saldo total)"}),f==="partial"&&e.jsx(m,{label:"Valor recebido",type:"number",fullWidth:!0,value:s.amountReceived||"",onChange:t=>d({...s,amountReceived:Number(t.target.value)}),InputProps:{inputProps:{min:0,max:(a==null?void 0:a.totals.amountOpen)||0,step:.01}},helperText:`Saldo em aberto: ${i((a==null?void 0:a.totals.amountOpen)||0)}`}),f==="full"&&e.jsx(m,{label:"Valor a quitar",fullWidth:!0,value:i((a==null?void 0:a.totals.amountOpen)||0),InputProps:{readOnly:!0}}),e.jsx(m,{label:"Data de recebimento",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},value:s.receivedAt||"",onChange:t=>d({...s,receivedAt:t.target.value})}),e.jsxs(m,{select:!0,label:"Método de pagamento",fullWidth:!0,value:s.method||"pix",onChange:t=>d({...s,method:t.target.value}),children:[e.jsx(j,{value:"pix",children:"PIX"}),e.jsx(j,{value:"boleto",children:"Boleto"}),e.jsx(j,{value:"transfer",children:"Transferência"}),e.jsx(j,{value:"card",children:"Cartão"}),e.jsx(j,{value:"cash",children:"Dinheiro"}),e.jsx(j,{value:"other",children:"Outro"})]}),e.jsx(m,{label:"Referência (NSU, TxID, etc.)",fullWidth:!0,value:s.reference||"",onChange:t=>d({...s,reference:t.target.value})}),e.jsx(m,{label:"Observações",fullWidth:!0,multiline:!0,rows:2,value:s.notes||"",onChange:t=>d({...s,notes:t.target.value})}),f==="full"&&e.jsx(F,{control:e.jsx(N,{checked:s.confirmPolicy||!1,onChange:t=>d({...s,confirmPolicy:t.target.checked})}),label:"Confirmo a baixa integral desta fatura (obrigatório)"})]})}),e.jsxs(le,{children:[e.jsx(x,{onClick:()=>g(!1),disabled:w,children:"Cancelar"}),e.jsx(x,{variant:"contained",onClick:U,disabled:w,children:w?e.jsx(H,{size:20}):"Confirmar"})]})]}),e.jsx(ce,{open:y.open,autoHideDuration:4e3,onClose:()=>b({...y,open:!1}),anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(de,{severity:y.severity,variant:"filled",onClose:()=>b({...y,open:!1}),children:y.message})})]}):e.jsxs(C,{sx:{p:3},children:[e.jsx(r,{variant:"h6",children:"Fatura não encontrada"}),e.jsx(x,{onClick:()=>O("/billing/invoices"),sx:{mt:2},children:"Voltar"})]})};export{Ae as default};
