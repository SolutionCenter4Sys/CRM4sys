import{r as t,j as s,B as L,T as g,P as y,b as n,m as o}from"./index-D1WZwRG5.js";import{S as f}from"./Stack-BDxuP9_X.js";import{M as r}from"./MenuItem-C9hTkJKZ.js";import{B as m}from"./Button-BhZ-lD3l.js";import{T as N,a as J,b as M,c as b,d as a,e as H}from"./TableRow-CbZqZsXt.js";import{C as K}from"./Chip-BcfuiGLT.js";import{S as V}from"./Snackbar-8yKmYgF-.js";import{A as Z}from"./Alert-C2uN4Clt.js";const se=()=>{const[T,E]=t.useState([]),[F,I]=t.useState([]),[S,q]=t.useState([]),[h,z]=t.useState("all"),[d,C]=t.useState(""),[R,w]=t.useState("billing.manage"),[x,k]=t.useState(""),[p,A]=t.useState(""),[v,B]=t.useState(""),[j,i]=t.useState({open:!1,message:"",severity:"success"}),U=async()=>{try{const[e,l]=await Promise.all([o.users.list(),o.access.listPermissionCatalog()]),c=e.data||[];E(c),I(l.data||[]),!d&&c[0]&&C(c[0].id)}catch(e){i({open:!0,message:e.message||"Falha ao carregar base",severity:"error"})}},u=async()=>{try{const e=await o.access.listElevationRequests({status:h});q(e.data||[])}catch(e){i({open:!0,message:e.message||"Falha ao carregar solicitações",severity:"error"})}};t.useEffect(()=>{U()},[]),t.useEffect(()=>{u()},[h]);const W=async()=>{if(!d||!x.trim()||!p||!v){i({open:!0,message:"Preencha todos os campos da solicitação.",severity:"error"});return}try{await o.access.requestElevation({userId:d,permissionKey:R,justification:x.trim(),validFrom:`${p}T00:00:00Z`,validUntil:`${v}T23:59:59Z`}),k(""),i({open:!0,message:"Solicitação criada com sucesso.",severity:"success"}),await u()}catch(e){i({open:!0,message:e.message||"Falha ao criar solicitação",severity:"error"})}},P=async(e,l)=>{try{await o.access.reviewElevationRequest(e,l,null),i({open:!0,message:l==="approve"?"Solicitação aprovada.":"Solicitação rejeitada.",severity:"success"}),await u()}catch(c){i({open:!0,message:c.message||"Falha ao revisar solicitação",severity:"error"})}},D=async e=>{try{await o.access.cancelElevationRequest(e),i({open:!0,message:"Solicitação cancelada.",severity:"success"}),await u()}catch(l){i({open:!0,message:l.message||"Falha ao cancelar solicitação",severity:"error"})}};return s.jsxs(L,{sx:{p:3},children:[s.jsx(g,{variant:"h4",fontWeight:700,sx:{mb:2},children:"Workflow de Elevação de Privilégios"}),s.jsxs(y,{sx:{p:2,mb:2},children:[s.jsx(g,{variant:"h6",sx:{mb:1},children:"Nova solicitação"}),s.jsxs(f,{direction:{xs:"column",md:"row"},spacing:2,children:[s.jsx(n,{select:!0,label:"Usuário solicitante",size:"small",value:d,onChange:e=>C(e.target.value),sx:{minWidth:280},children:T.map(e=>s.jsx(r,{value:e.id,children:e.fullName},e.id))}),s.jsx(n,{select:!0,label:"Permissão",size:"small",value:R,onChange:e=>w(e.target.value),sx:{minWidth:280},children:F.map(e=>s.jsx(r,{value:e.key,children:e.label},e.key))}),s.jsx(n,{size:"small",type:"date",label:"Início",value:p,onChange:e=>A(e.target.value),InputLabelProps:{shrink:!0}}),s.jsx(n,{size:"small",type:"date",label:"Fim",value:v,onChange:e=>B(e.target.value),InputLabelProps:{shrink:!0}})]}),s.jsx(n,{fullWidth:!0,label:"Justificativa",multiline:!0,minRows:2,value:x,onChange:e=>k(e.target.value),sx:{mt:2}}),s.jsx(m,{variant:"contained",sx:{mt:2},onClick:W,children:"Solicitar elevação"})]}),s.jsx(y,{sx:{p:2,mb:2},children:s.jsx(f,{direction:"row",spacing:2,children:s.jsxs(n,{select:!0,size:"small",label:"Status",value:h,onChange:e=>z(e.target.value),sx:{minWidth:220},children:[s.jsx(r,{value:"all",children:"Todos"}),s.jsx(r,{value:"pending",children:"Pendente"}),s.jsx(r,{value:"approved",children:"Aprovado"}),s.jsx(r,{value:"rejected",children:"Rejeitado"}),s.jsx(r,{value:"cancelled",children:"Cancelado"}),s.jsx(r,{value:"expired",children:"Expirado"})]})})}),s.jsx(N,{component:y,children:s.jsxs(J,{size:"small",children:[s.jsx(M,{children:s.jsxs(b,{children:[s.jsx(a,{children:"Solicitante"}),s.jsx(a,{children:"Permissão"}),s.jsx(a,{children:"Período"}),s.jsx(a,{children:"Justificativa"}),s.jsx(a,{children:"Status"}),s.jsx(a,{align:"right",children:"Ações"})]})}),s.jsx(H,{children:S.length===0?s.jsx(b,{children:s.jsx(a,{colSpan:6,align:"center",children:s.jsx(g,{variant:"body2",color:"text.secondary",sx:{py:3},children:"Nenhuma solicitação encontrada."})})}):S.map(e=>s.jsxs(b,{children:[s.jsx(a,{children:e.userName}),s.jsx(a,{children:e.permissionLabel}),s.jsxs(a,{children:[new Date(e.validFrom).toLocaleDateString("pt-BR")," a ",new Date(e.validUntil).toLocaleDateString("pt-BR")]}),s.jsx(a,{children:e.justification}),s.jsx(a,{children:s.jsx(K,{size:"small",label:e.status,color:e.status==="approved"?"success":e.status==="rejected"?"error":"default"})}),s.jsx(a,{align:"right",children:e.status==="pending"?s.jsxs(f,{direction:"row",spacing:1,justifyContent:"flex-end",children:[s.jsx(m,{size:"small",color:"success",onClick:()=>P(e.requestId,"approve"),children:"Aprovar"}),s.jsx(m,{size:"small",color:"error",onClick:()=>P(e.requestId,"reject"),children:"Rejeitar"}),e.canCancel&&s.jsx(m,{size:"small",onClick:()=>D(e.requestId),children:"Cancelar"})]}):"-"})]},e.requestId))})]})}),s.jsx(V,{open:j.open,autoHideDuration:3500,onClose:()=>i(e=>({...e,open:!1})),children:s.jsx(Z,{severity:j.severity,variant:"filled",onClose:()=>i(e=>({...e,open:!1})),children:j.message})})]})};export{se as default};
