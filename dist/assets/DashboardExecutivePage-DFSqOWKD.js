import{u as K,a as q,r as c,j as e,B as d,T as s,P as j,F as _,I as z,S as E,b as v,C as A,c as G,m as B}from"./index-D1WZwRG5.js";import{S as m}from"./Stack-BDxuP9_X.js";import{B as u}from"./Button-BhZ-lD3l.js";import{M as o}from"./MenuItem-C9hTkJKZ.js";import{A as H}from"./Alert-C2uN4Clt.js";import{C,a as S}from"./CardContent-C09eNwcx.js";import{C as J}from"./Chip-BcfuiGLT.js";import{D as Q}from"./Drawer-7E5gQ_7V.js";const b={previous_period:"Período anterior",last_year:"Mesmo período ano anterior",custom:"Range customizado",none:"Sem comparação"},ne=()=>{var F;const P=K(),[t,k]=q(),[W,I]=c.useState(!0),[D,f]=c.useState(null),[g,$]=c.useState(null),[x,y]=c.useState([]),[N,T]=c.useState(!1),r=c.useMemo(()=>({datePreset:t.get("datePreset")||"this_quarter",dateFrom:t.get("dateFrom")||void 0,dateTo:t.get("dateTo")||void 0,team:t.get("team")||void 0,pipelineId:t.get("pipelineId")||void 0,ownerId:t.get("ownerId")||void 0,compareTo:t.get("compareTo")||"previous_period",compareFrom:t.get("compareFrom")||void 0,compareToDate:t.get("compareToDate")||void 0}),[t]),p=(a,n)=>{const i=new URLSearchParams(t);n?i.set(a,n):i.delete(a),k(i)},M=async()=>{try{I(!0),f(null);const a=await B.analytics.getExecutiveDashboard(r);$(a.data||null)}catch(a){f(a instanceof Error?a.message:"Erro ao carregar dashboard")}finally{I(!1)}};c.useEffect(()=>{M()},[t.toString()]);const L=async a=>{try{T(!0);const n=await B.analytics.getDrilldown(a,r);n.data&&y(i=>[...i,n.data])}finally{T(!1)}},h=x[x.length-1],O=()=>{if(!h)return;const a=["Title","Owner","Stage","Status","Amount"],n=h.records.map(l=>[l.title,l.ownerName||"",l.stageName||"",l.status||"",String(l.amount||"")]),i=[a,...n].map(l=>l.map(V=>`"${V.replace(/"/g,'""')}"`).join(",")).join(`
`),U=new Blob([i],{type:"text/csv;charset=utf-8;"}),R=URL.createObjectURL(U),w=document.createElement("a");w.href=R,w.download=`segment-${h.metricKey}.csv`,w.click(),URL.revokeObjectURL(R)};return e.jsxs(d,{sx:{p:3},children:[e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,gap:2,flexWrap:"wrap"},children:[e.jsxs(d,{children:[e.jsx(s,{variant:"h4",sx:{fontWeight:700},children:"Dashboard Executivo"}),e.jsx(s,{variant:"body2",color:"text.secondary",children:"KPIs e tendências para gestão comercial e reporting executivo."})]}),e.jsxs(m,{direction:"row",spacing:1,children:[e.jsx(u,{variant:"outlined",onClick:()=>P("/reports"),children:"Reports"}),e.jsx(u,{variant:"contained",onClick:()=>P("/dashboard/analytics"),children:"Dashboard Analítico"})]})]}),e.jsx(j,{sx:{p:2,mb:2},children:e.jsxs(m,{direction:{xs:"column",md:"row"},spacing:1.5,children:[e.jsxs(_,{size:"small",sx:{minWidth:160},children:[e.jsx(z,{children:"Período"}),e.jsxs(E,{value:r.datePreset,label:"Período",onChange:a=>p("datePreset",a.target.value),children:[e.jsx(o,{value:"this_month",children:"Mês atual"}),e.jsx(o,{value:"this_quarter",children:"Trimestre atual"}),e.jsx(o,{value:"this_year",children:"Ano atual"}),e.jsx(o,{value:"custom",children:"Custom"})]})]}),r.datePreset==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(v,{size:"small",type:"date",label:"De",value:r.dateFrom||"",onChange:a=>p("dateFrom",a.target.value),InputLabelProps:{shrink:!0}}),e.jsx(v,{size:"small",type:"date",label:"Até",value:r.dateTo||"",onChange:a=>p("dateTo",a.target.value),InputLabelProps:{shrink:!0}})]}),e.jsxs(_,{size:"small",sx:{minWidth:200},children:[e.jsx(z,{children:"Comparação"}),e.jsxs(E,{value:r.compareTo||"previous_period",label:"Comparação",onChange:a=>p("compareTo",a.target.value),children:[e.jsx(o,{value:"previous_period",children:b.previous_period}),e.jsx(o,{value:"last_year",children:b.last_year}),e.jsx(o,{value:"custom",children:b.custom}),e.jsx(o,{value:"none",children:b.none})]})]}),e.jsx(v,{size:"small",label:"Pipeline ID",value:r.pipelineId||"",onChange:a=>p("pipelineId",a.target.value||void 0)}),e.jsx(v,{size:"small",label:"Owner ID",value:r.ownerId||"",onChange:a=>p("ownerId",a.target.value||void 0)})]})}),D&&e.jsx(H,{severity:"error",sx:{mb:2},onClose:()=>f(null),children:D}),W||!g?e.jsx(d,{sx:{py:6,textAlign:"center"},children:e.jsx(A,{})}):e.jsxs(e.Fragment,{children:[e.jsx(d,{sx:{display:"grid",gridTemplateColumns:"repeat(5, minmax(170px, 1fr))",gap:1.5,mb:2},children:g.kpis.map(a=>e.jsx(C,{variant:"outlined",children:e.jsxs(S,{children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:a.label}),e.jsx(s,{variant:"h6",sx:{fontWeight:700},children:a.formattedValue}),e.jsx(J,{size:"small",label:`${a.comparisonValue>=0?"+":""}${a.comparisonValue.toFixed(1)} ${a.comparisonLabel}`,color:a.trend==="up"?"success":a.trend==="down"?"error":"default",variant:"outlined",sx:{mt:.7}}),e.jsx(d,{sx:{mt:1},children:e.jsx(u,{size:"small",onClick:()=>L(a.segmentKey),children:"Drill-down"})})]})},a.key))}),e.jsxs(d,{sx:{display:"grid",gridTemplateColumns:"1.6fr 1fr",gap:2},children:[e.jsx(C,{children:e.jsxs(S,{children:[e.jsx(s,{variant:"h6",sx:{mb:1.2},children:"Pipeline por estágio"}),e.jsx(m,{spacing:1,children:(((F=g.charts.find(a=>a.id==="pipeline_by_stage"))==null?void 0:F.points)||[]).map(a=>e.jsxs(j,{variant:"outlined",sx:{p:1.2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(s,{variant:"body2",sx:{fontWeight:600},children:a.label}),e.jsxs(m,{direction:"row",spacing:1,alignItems:"center",children:[e.jsxs(s,{variant:"caption",children:["R$ ",a.value.toLocaleString("pt-BR")]}),e.jsx(u,{size:"small",onClick:()=>L(a.segmentKey||a.label),children:"Ver"})]})]},a.label))})]})}),e.jsx(C,{children:e.jsxs(S,{children:[e.jsx(s,{variant:"h6",sx:{mb:1.2},children:"Top performers"}),e.jsx(m,{spacing:1,children:g.topPerformers.map((a,n)=>e.jsxs(j,{variant:"outlined",sx:{p:1},children:[e.jsxs(s,{variant:"body2",sx:{fontWeight:700},children:[n+1,". ",a.name]}),e.jsxs(s,{variant:"caption",color:"text.secondary",children:[a.wins," wins • R$ ",a.revenue.toLocaleString("pt-BR")]})]},a.userId))})]})})]})]}),e.jsxs(Q,{anchor:"right",open:!!h,onClose:()=>y([]),PaperProps:{sx:{width:{xs:"100%",md:520},p:2}},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:x.length>0?x[x.length-1].path.join(" > "):""}),e.jsx(s,{variant:"h6",sx:{mb:1},children:"Segmento detalhado"}),e.jsxs(m,{direction:"row",spacing:1,sx:{mb:1.5},children:[x.length>1&&e.jsx(u,{variant:"outlined",onClick:()=>y(a=>a.slice(0,-1)),children:"Voltar nível"}),e.jsx(u,{variant:"outlined",startIcon:e.jsx(G,{}),onClick:O,children:"Exportar segmento"})]}),N?e.jsx(A,{size:22}):h?e.jsx(m,{spacing:1,children:h.records.map(a=>e.jsxs(j,{variant:"outlined",sx:{p:1.2},children:[e.jsx(s,{variant:"body2",sx:{fontWeight:700},children:a.title}),e.jsxs(s,{variant:"caption",color:"text.secondary",children:[a.ownerName||"Sem owner"," • ",a.stageName||"Sem estágio"," •"," ",a.status||"N/A"," • R$ ",(a.amount||0).toLocaleString("pt-BR")]})]},a.id))}):null]})]})};export{ne as default};
