import{g as de,d as ue,r as n,e as me,_ as fe,f as R,h as pe,j as e,i as ge,k as x,l as xe,s as I,n as z,o as he,p as be,q as F,u as ve,a as ye,t as X,B as l,C as je,T as i,D as k,m as $}from"./index-D1WZwRG5.js";import{B as H}from"./Button-BhZ-lD3l.js";import{A as Ce}from"./Alert-C2uN4Clt.js";import{C as m}from"./Chip-BcfuiGLT.js";import{C as S,a as B}from"./CardContent-C09eNwcx.js";function Pe(a){return de("MuiLinearProgress",a)}ue("MuiLinearProgress",["root","colorPrimary","colorSecondary","determinate","indeterminate","buffer","query","dashed","dashedColorPrimary","dashedColorSecondary","bar","barColorPrimary","barColorSecondary","bar1Indeterminate","bar1Determinate","bar1Buffer","bar2Indeterminate","bar2Buffer"]);const $e=["className","color","value","valueBuffer","variant"];let M=a=>a,J,Q,Y,Z,ee,re;const q=4,Re=F(J||(J=M`
  0% {
    left: -35%;
    right: 100%;
  }

  60% {
    left: 100%;
    right: -90%;
  }

  100% {
    left: 100%;
    right: -90%;
  }
`)),Me=F(Q||(Q=M`
  0% {
    left: -200%;
    right: 100%;
  }

  60% {
    left: 107%;
    right: -8%;
  }

  100% {
    left: 107%;
    right: -8%;
  }
`)),De=F(Y||(Y=M`
  0% {
    opacity: 1;
    background-position: 0 -23px;
  }

  60% {
    opacity: 0;
    background-position: 0 -23px;
  }

  100% {
    opacity: 1;
    background-position: -200px -23px;
  }
`)),we=a=>{const{classes:s,variant:o,color:p}=a,v={root:["root",`color${x(p)}`,o],dashed:["dashed",`dashedColor${x(p)}`],bar1:["bar",`barColor${x(p)}`,(o==="indeterminate"||o==="query")&&"bar1Indeterminate",o==="determinate"&&"bar1Determinate",o==="buffer"&&"bar1Buffer"],bar2:["bar",o!=="buffer"&&`barColor${x(p)}`,o==="buffer"&&`color${x(p)}`,(o==="indeterminate"||o==="query")&&"bar2Indeterminate",o==="buffer"&&"bar2Buffer"]};return xe(v,Pe,s)},O=(a,s)=>s==="inherit"?"currentColor":a.vars?a.vars.palette.LinearProgress[`${s}Bg`]:a.palette.mode==="light"?he(a.palette[s].main,.62):be(a.palette[s].main,.5),Se=I("span",{name:"MuiLinearProgress",slot:"Root",overridesResolver:(a,s)=>{const{ownerState:o}=a;return[s.root,s[`color${x(o.color)}`],s[o.variant]]}})(({ownerState:a,theme:s})=>R({position:"relative",overflow:"hidden",display:"block",height:4,zIndex:0,"@media print":{colorAdjust:"exact"},backgroundColor:O(s,a.color)},a.color==="inherit"&&a.variant!=="buffer"&&{backgroundColor:"none","&::before":{content:'""',position:"absolute",left:0,top:0,right:0,bottom:0,backgroundColor:"currentColor",opacity:.3}},a.variant==="buffer"&&{backgroundColor:"transparent"},a.variant==="query"&&{transform:"rotate(180deg)"})),Be=I("span",{name:"MuiLinearProgress",slot:"Dashed",overridesResolver:(a,s)=>{const{ownerState:o}=a;return[s.dashed,s[`dashedColor${x(o.color)}`]]}})(({ownerState:a,theme:s})=>{const o=O(s,a.color);return R({position:"absolute",marginTop:0,height:"100%",width:"100%"},a.color==="inherit"&&{opacity:.3},{backgroundImage:`radial-gradient(${o} 0%, ${o} 16%, transparent 42%)`,backgroundSize:"10px 10px",backgroundPosition:"0 -23px"})},z(Z||(Z=M`
    animation: ${0} 3s infinite linear;
  `),De)),Le=I("span",{name:"MuiLinearProgress",slot:"Bar1",overridesResolver:(a,s)=>{const{ownerState:o}=a;return[s.bar,s[`barColor${x(o.color)}`],(o.variant==="indeterminate"||o.variant==="query")&&s.bar1Indeterminate,o.variant==="determinate"&&s.bar1Determinate,o.variant==="buffer"&&s.bar1Buffer]}})(({ownerState:a,theme:s})=>R({width:"100%",position:"absolute",left:0,bottom:0,top:0,transition:"transform 0.2s linear",transformOrigin:"left",backgroundColor:a.color==="inherit"?"currentColor":(s.vars||s).palette[a.color].main},a.variant==="determinate"&&{transition:`transform .${q}s linear`},a.variant==="buffer"&&{zIndex:1,transition:`transform .${q}s linear`}),({ownerState:a})=>(a.variant==="indeterminate"||a.variant==="query")&&z(ee||(ee=M`
      width: auto;
      animation: ${0} 2.1s cubic-bezier(0.65, 0.815, 0.735, 0.395) infinite;
    `),Re)),ke=I("span",{name:"MuiLinearProgress",slot:"Bar2",overridesResolver:(a,s)=>{const{ownerState:o}=a;return[s.bar,s[`barColor${x(o.color)}`],(o.variant==="indeterminate"||o.variant==="query")&&s.bar2Indeterminate,o.variant==="buffer"&&s.bar2Buffer]}})(({ownerState:a,theme:s})=>R({width:"100%",position:"absolute",left:0,bottom:0,top:0,transition:"transform 0.2s linear",transformOrigin:"left"},a.variant!=="buffer"&&{backgroundColor:a.color==="inherit"?"currentColor":(s.vars||s).palette[a.color].main},a.color==="inherit"&&{opacity:.3},a.variant==="buffer"&&{backgroundColor:O(s,a.color),transition:`transform .${q}s linear`}),({ownerState:a})=>(a.variant==="indeterminate"||a.variant==="query")&&z(re||(re=M`
      width: auto;
      animation: ${0} 2.1s cubic-bezier(0.165, 0.84, 0.44, 1) 1.15s infinite;
    `),Me)),Ie=n.forwardRef(function(s,o){const p=me({props:s,name:"MuiLinearProgress"}),{className:v,color:D="primary",value:y,valueBuffer:L,variant:u="indeterminate"}=p,A=fe(p,$e),h=R({},p,{color:D,variant:u}),j=we(h),w=pe(),C={},f={bar1:{},bar2:{}};if((u==="determinate"||u==="buffer")&&y!==void 0){C["aria-valuenow"]=Math.round(y),C["aria-valuemin"]=0,C["aria-valuemax"]=100;let g=y-100;w&&(g=-g),f.bar1.transform=`translateX(${g}%)`}if(u==="buffer"&&L!==void 0){let g=(L||0)-100;w&&(g=-g),f.bar2.transform=`translateX(${g}%)`}return e.jsxs(Se,R({className:ge(j.root,v),ownerState:h,role:"progressbar"},C,{ref:o},A,{children:[u==="buffer"?e.jsx(Be,{className:j.dashed,ownerState:h}):null,e.jsx(Le,{className:j.bar1,ownerState:h,style:f.bar1}),u==="determinate"?null:e.jsx(ke,{className:j.bar2,ownerState:h,style:f.bar2})]}))}),Ee=()=>{const a=ve(),[s]=ye(),[o,p]=n.useState(!0),[v,D]=n.useState(null),[y,L]=n.useState([]),[u,A]=n.useState([]),[h,j]=n.useState([]),[w,C]=n.useState([]),[f,g]=n.useState(()=>X()),[U,ae]=n.useState(null);n.useEffect(()=>{(async()=>{try{p(!0),D(null);const[t,c,b,E,le]=await Promise.all([$.accounts.list(),$.deals.list(),$.activities.list(),$.pipelines.list(),$.analytics.getExecutiveDashboard({datePreset:s.get("datePreset")||"this_quarter",compareTo:s.get("compareTo")||"previous_period"})]),K=(E.data||[])[0],ce=K?await $.pipelines.listStages(K.id):{data:[]};L(t.data||[]),A(c.data||[]),j(b.data||[]),C(ce.data||[]),ae(le.data||null)}catch(t){D(t instanceof Error?t.message:"Erro ao carregar dashboard analítico")}finally{p(!1)}})()},[s.toString()]),n.useEffect(()=>{const r=()=>g(X()),t=window.setInterval(r,1500);return()=>window.clearInterval(t)},[]);const d=n.useMemo(()=>u.filter(r=>r.status==="open"),[u]),P=n.useMemo(()=>u.filter(r=>r.status==="won"),[u]),T=n.useMemo(()=>u.filter(r=>r.status==="lost"),[u]),te=n.useMemo(()=>d.reduce((r,t)=>r+t.amount,0),[d]),se=n.useMemo(()=>d.reduce((r,t)=>r+t.weightedAmount,0),[d]),oe=n.useMemo(()=>P.reduce((r,t)=>r+t.amount,0),[P]),V=n.useMemo(()=>{const r=P.length+T.length;return r===0?0:P.length/r*100},[P.length,T.length]),G=n.useMemo(()=>d.length===0?0:d.reduce((r,t)=>r+(t.rottingDays||0),0)/d.length,[d]),ne=n.useMemo(()=>{const t=Date.now()-7*24*60*60*1e3;return h.filter(c=>new Date(c.activityDate).getTime()>=t).length},[h]),_=n.useMemo(()=>{const r=w.map(t=>({stageId:t.id,stageName:t.name,count:0,value:0,probability:t.probability,color:t.color}));return d.forEach(t=>{const c=r.find(b=>b.stageId===t.stageId);c&&(c.count+=1,c.value+=t.amount)}),r},[d,w]),ie=n.useMemo(()=>Math.max(1,..._.map(r=>r.value)),[_]),N=n.useMemo(()=>{const r=new Map;return d.forEach(t=>{const c=t.account||y.find(E=>E.id===t.accountId);if(!c)return;const b=r.get(c.id)||{account:c,value:0,deals:0};b.value+=t.amount,b.deals+=1,r.set(c.id,b)}),Array.from(r.values()).sort((t,c)=>c.value-t.value).slice(0,5)},[d,y]),W=n.useMemo(()=>d.filter(r=>(r.rottingDays||0)>=7).sort((r,t)=>(t.rottingDays||0)-(r.rottingDays||0)).slice(0,6),[d]);return o?e.jsx(l,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(je,{})}):e.jsxs(l,{sx:{p:3},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,gap:2,flexWrap:"wrap"},children:[e.jsxs(l,{children:[e.jsx(i,{variant:"h4",sx:{fontWeight:700},children:"Dashboard Analítico"}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Métricas e monitoramento comercial consolidados."})]}),e.jsxs(l,{sx:{display:"flex",gap:1},children:[e.jsx(H,{variant:"outlined",onClick:()=>a("/dashboard"),children:"Voltar para Home"}),e.jsx(H,{variant:"contained",onClick:()=>a("/deals"),children:"Abrir Pipeline"})]})]}),v&&e.jsx(Ce,{severity:"error",sx:{mb:2},onClose:()=>D(null),children:v}),e.jsxs(l,{sx:{display:"grid",gridTemplateColumns:"repeat(6, minmax(140px, 1fr))",gap:1.5,mb:2},children:[U&&e.jsx(m,{label:`Comparação global: ${U.filters.compareTo||"previous_period"}`,color:"secondary",variant:"outlined"}),e.jsx(m,{label:`Open Pipeline: R$ ${te.toLocaleString("pt-BR")}`,color:"primary"}),e.jsx(m,{label:`Forecast: R$ ${se.toLocaleString("pt-BR")}`,color:"info"}),e.jsx(m,{label:`Ganhos: R$ ${oe.toLocaleString("pt-BR")}`,color:"success"}),e.jsx(m,{label:`Win Rate: ${V.toFixed(1)}%`,color:V>=35?"success":"warning"}),e.jsx(m,{label:`Aging médio: ${G.toFixed(1)}d`,color:G>=8?"warning":"default"}),e.jsx(m,{label:`Atividades 7d: ${ne}`,color:"secondary"})]}),e.jsxs(l,{sx:{display:"grid",gridTemplateColumns:"1.6fr 1fr",gap:2},children:[e.jsx(S,{children:e.jsxs(B,{children:[e.jsx(i,{variant:"h6",sx:{fontWeight:700,mb:1.5},children:"Funil por Estágio"}),e.jsx(l,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:_.map(r=>{const t=r.value/ie*100;return e.jsxs(l,{children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:.5},children:[e.jsx(i,{variant:"body2",sx:{fontWeight:600},children:r.stageName}),e.jsxs(i,{variant:"caption",color:"text.secondary",children:[r.count," deal(s) • R$ ",r.value.toLocaleString("pt-BR")," •"," ",r.probability,"%"]})]}),e.jsx(Ie,{variant:"determinate",value:t,sx:{height:9,borderRadius:99,"& .MuiLinearProgress-bar":{backgroundColor:r.color}}})]},r.stageId)})})]})}),e.jsx(S,{children:e.jsxs(B,{children:[e.jsx(i,{variant:"h6",sx:{fontWeight:700,mb:1.5},children:"Distribuição de Status"}),e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:1.2},children:[e.jsx(m,{label:`Abertos: ${d.length}`,color:"default",variant:"outlined"}),e.jsx(m,{label:`Ganhos: ${P.length}`,color:"success",variant:"outlined"}),e.jsx(m,{label:`Perdidos: ${T.length}`,color:"error",variant:"outlined"}),e.jsx(k,{sx:{my:.5}}),e.jsxs(i,{variant:"caption",color:"text.secondary",children:["Total de deals monitorados: ",u.length]})]})]})})]}),e.jsxs(l,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:2,mt:2},children:[e.jsx(S,{children:e.jsxs(B,{children:[e.jsx(i,{variant:"h6",sx:{fontWeight:700,mb:1.5},children:"Top Contas por Pipeline Aberto"}),N.length===0?e.jsx(i,{variant:"body2",color:"text.secondary",children:"Sem contas com deals abertos."}):N.map((r,t)=>e.jsxs(l,{sx:{py:1},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",gap:1},children:[e.jsxs(i,{variant:"body2",sx:{fontWeight:600},children:[t+1,". ",r.account.name]}),e.jsxs(i,{variant:"body2",children:["R$ ",r.value.toLocaleString("pt-BR")]})]}),e.jsxs(i,{variant:"caption",color:"text.secondary",children:[r.deals," deal(s) aberto(s)"]}),t<N.length-1&&e.jsx(k,{sx:{mt:1.2}})]},r.account.id))]})}),e.jsx(S,{children:e.jsxs(B,{children:[e.jsx(i,{variant:"h6",sx:{fontWeight:700,mb:1.5},children:"Prioridades (Rotting)"}),W.length===0?e.jsx(i,{variant:"body2",color:"text.secondary",children:"Nenhum deal crítico no momento."}):W.map((r,t)=>{var c;return e.jsxs(l,{sx:{py:1},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:1},children:[e.jsx(i,{variant:"body2",sx:{fontWeight:600},children:r.title}),e.jsx(m,{size:"small",color:(r.rottingDays||0)>=10?"error":"warning",label:`${r.rottingDays||0}d`})]}),e.jsx(i,{variant:"caption",color:"text.secondary",children:((c=r.account)==null?void 0:c.name)||"Conta não definida"}),t<W.length-1&&e.jsx(k,{sx:{mt:1.2}})]},r.id)})]})})]}),e.jsx(l,{sx:{display:"grid",gridTemplateColumns:"1fr",gap:2,mt:2},children:e.jsx(S,{children:e.jsxs(B,{children:[e.jsx(i,{variant:"h6",sx:{fontWeight:700,mb:1.5},children:"Performance de Navegação (local)"}),e.jsxs(l,{sx:{display:"flex",gap:1,flexWrap:"wrap",mb:1.5},children:[e.jsx(m,{label:`Medições: ${f.count}`,variant:"outlined"}),e.jsx(m,{label:`Média: ${f.avgMs.toFixed(1)}ms`,color:f.avgMs<=120?"success":"warning",variant:"outlined"}),e.jsx(m,{label:`P95: ${f.p95Ms.toFixed(1)}ms`,color:f.p95Ms<=220?"success":"warning",variant:"outlined"})]}),f.recent.length===0?e.jsx(i,{variant:"body2",color:"text.secondary",children:"Sem dados ainda. Navegue entre as telas para coletar métricas."}):f.recent.map((r,t)=>e.jsxs(l,{sx:{py:.8},children:[e.jsxs(i,{variant:"body2",sx:{fontWeight:600},children:[r.from," ","->"," ",r.to]}),e.jsxs(i,{variant:"caption",color:"text.secondary",children:[r.durationMs.toFixed(1),"ms •"," ",new Date(r.timestamp).toLocaleTimeString("pt-BR")]}),t<f.recent.length-1&&e.jsx(k,{sx:{mt:1}})]},`${r.timestamp}-${t}`))]})})})]})};export{Ee as DashboardAnalyticsPage,Ee as default};
