import{Z as ee,u as ae,r as o,j as e,B as n,C as te,T as s,D as N,b as se,m as x}from"./index-D1WZwRG5.js";import{D as re}from"./DealFormModal-Q0-oxKjZ.js";import{B as l}from"./Button-BhZ-lD3l.js";import{A as oe}from"./ArrowBack-ChqsaD63.js";import{A as $}from"./Alert-C2uN4Clt.js";import{C as F,a as O}from"./CardContent-C09eNwcx.js";import{C as p}from"./Chip-BcfuiGLT.js";import{E as ne}from"./Edit-DEHhOGnU.js";import{T as ie,a as w}from"./Tabs-CY_i16F1.js";import{G as m}from"./Grid-DMeR_RpR.js";import{D as le,a as ce,b as de,c as xe}from"./DialogTitle-CaeVllRe.js";import"./Stack-BDxuP9_X.js";import"./MenuItem-C9hTkJKZ.js";import"./KeyboardArrowRight-DRYK2Ozh.js";const S=({value:c,index:u,children:g})=>c!==u?null:e.jsx(n,{sx:{py:2},children:g}),Ee=()=>{var W,L,P,z;const{id:c}=ee(),u=ae(),[g,E]=o.useState(!0),[a,V]=o.useState(null),[d,_]=o.useState([]),[G,H]=o.useState([]),[h,U]=o.useState(0),[Z,R]=o.useState(!1),[B,T]=o.useState(null),[k,y]=o.useState(null),[A,I]=o.useState(null),[q,j]=o.useState(!1),[b,M]=o.useState(""),v=async t=>{try{E(!0),T(null),y(null);const r=await x.deals.getById(t);if(!r.data)throw new Error("Deal não encontrado");const i=r.data;V(i);const[f,K]=await Promise.all([x.activities.listByDeal(t),x.pipelines.listStages(i.pipelineId)]),Q=(f.data||[]).sort((X,Y)=>new Date(Y.activityDate).getTime()-new Date(X.activityDate).getTime());_(Q),H(K.data||[])}catch(r){T(r instanceof Error?r.message:"Erro ao carregar deal")}finally{E(!1)}};o.useEffect(()=>{c&&v(c)},[c]);const D=o.useMemo(()=>d.filter(t=>t.type==="stage_change"),[d]),J=async t=>{a&&(await x.deals.update(a.id,t),await v(a.id))},C=async(t,r)=>{if(a)try{await x.deals.setStatus(a.id,t,r),await v(a.id),I(t==="won"?"Deal marcado como ganho com sucesso.":t==="lost"?"Deal marcado como perdido.":"Deal reaberto.")}catch(i){y(i instanceof Error?i.message:"Falha ao atualizar status do deal")}};return g?e.jsx(n,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(te,{})}):B||!a?e.jsxs(n,{sx:{p:3},children:[e.jsx(s,{variant:"h6",children:B||"Deal não encontrado"}),e.jsx(l,{sx:{mt:2},onClick:()=>u("/deals"),children:"Voltar para pipeline"})]}):e.jsxs(n,{sx:{p:3},children:[e.jsx(l,{startIcon:e.jsx(oe,{}),onClick:()=>u("/deals"),sx:{mb:2},children:"Voltar para Pipeline"}),A&&e.jsx($,{severity:"success",sx:{mb:2},onClose:()=>I(null),children:A}),k&&e.jsx($,{severity:"error",sx:{mb:2},onClose:()=>y(null),children:k}),e.jsx(F,{sx:{mb:2},children:e.jsx(O,{children:e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:2},children:[e.jsxs(n,{children:[e.jsx(s,{variant:"h4",sx:{fontWeight:700},children:a.title}),e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mb:1.5},children:((W=a.account)==null?void 0:W.name)||"Conta não informada"}),e.jsxs(n,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(p,{label:`Estágio: ${((L=a.stage)==null?void 0:L.name)||"—"}`,color:"primary",size:"small"}),e.jsx(p,{label:`Probabilidade: ${a.probability}%`,size:"small",variant:"outlined"}),e.jsx(p,{label:`Status: ${a.status.toUpperCase()}`,color:a.status==="won"?"success":a.status==="lost"?"error":"default",size:"small",variant:"outlined"}),e.jsx(p,{label:`Valor: R$ ${a.amount.toLocaleString("pt-BR")}`,size:"small",variant:"outlined"}),a.lostReason&&e.jsx(p,{label:`Motivo perda: ${a.lostReason}`,color:"error",size:"small",variant:"outlined"})]})]}),e.jsxs(n,{sx:{display:"flex",gap:1,flexWrap:"wrap",justifyContent:"flex-end"},children:[e.jsx(l,{variant:"outlined",startIcon:e.jsx(ne,{}),onClick:()=>R(!0),children:"Editar Deal"}),e.jsx(l,{variant:"contained",color:"success",onClick:()=>C("won"),disabled:a.status==="won",children:"Marcar ganho"}),e.jsx(l,{variant:"contained",color:"error",onClick:()=>j(!0),disabled:a.status==="lost",children:"Marcar perdido"}),e.jsx(l,{variant:"text",onClick:()=>C("open"),disabled:a.status==="open",children:"Reabrir"})]})]})})}),e.jsx(F,{children:e.jsxs(O,{children:[e.jsxs(ie,{value:h,onChange:(t,r)=>U(r),children:[e.jsx(w,{label:"Visão Geral"}),e.jsx(w,{label:"Atividades"}),e.jsx(w,{label:"Histórico de Estágio"})]}),e.jsx(S,{value:h,index:0,children:e.jsxs(m,{container:!0,spacing:2,children:[e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Descrição"}),e.jsx(s,{variant:"body2",children:a.description||"Sem descrição"})]}),e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Fechamento previsto"}),e.jsx(s,{variant:"body2",children:a.expectedCloseDate?new Date(a.expectedCloseDate).toLocaleDateString("pt-BR"):"Não definido"})]}),e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Owner"}),e.jsx(s,{variant:"body2",children:((P=a.owner)==null?void 0:P.fullName)||"—"})]}),e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Contato principal"}),e.jsx(s,{variant:"body2",children:((z=a.primaryContact)==null?void 0:z.fullName)||"—"})]})]})}),e.jsx(S,{value:h,index:1,children:d.length===0?e.jsx(s,{variant:"body2",color:"text.secondary",children:"Nenhuma atividade registrada para este deal."}):d.map((t,r)=>e.jsxs(n,{sx:{py:1},children:[e.jsx(s,{variant:"body2",sx:{fontWeight:600},children:t.subject}),e.jsxs(s,{variant:"caption",color:"text.secondary",children:[new Date(t.activityDate).toLocaleString("pt-BR")," • ",t.type]}),t.description&&e.jsx(s,{variant:"body2",sx:{mt:.5},children:t.description}),r<d.length-1&&e.jsx(N,{sx:{mt:1.5}})]},t.id))}),e.jsx(S,{value:h,index:2,children:D.length===0?e.jsx(s,{variant:"body2",color:"text.secondary",children:"Nenhuma movimentação de estágio registrada."}):D.map((t,r)=>{var i,f;return e.jsxs(n,{sx:{py:1},children:[e.jsxs(s,{variant:"body2",sx:{fontWeight:600},children:[((i=t.metadata)==null?void 0:i.from_stage)||"—"," ","->"," ",((f=t.metadata)==null?void 0:f.to_stage)||"—"]}),e.jsx(s,{variant:"caption",color:"text.secondary",children:new Date(t.activityDate).toLocaleString("pt-BR")}),r<D.length-1&&e.jsx(N,{sx:{mt:1.5}})]},t.id)})})]})}),e.jsx(re,{open:Z,mode:"edit",initialData:a,onClose:()=>R(!1),onSubmit:J,pipelineId:a.pipelineId,stages:G}),e.jsxs(le,{open:q,onClose:()=>j(!1),fullWidth:!0,maxWidth:"sm",children:[e.jsx(ce,{children:"Marcar deal como perdido"}),e.jsx(de,{children:e.jsx(se,{autoFocus:!0,fullWidth:!0,multiline:!0,minRows:3,sx:{mt:1},label:"Motivo da perda",value:b,onChange:t=>M(t.target.value)})}),e.jsxs(xe,{children:[e.jsx(l,{onClick:()=>j(!1),children:"Cancelar"}),e.jsx(l,{color:"error",variant:"contained",onClick:async()=>{await C("lost",b),j(!1),M("")},disabled:!b.trim(),children:"Confirmar perda"})]})]})]})};export{Ee as DealDetailPage,Ee as default};
